#!/usr/bin/env python3
import hashlib
import sqlite3
import sys
import os
import re

# Ref: Spatia-Shatter-Core
# Handles Generic, Software, and Legal Atoms

class ShatterCore:
    def __init__(self, db_path=".spatia/sentinel.db"):
        self.conn = sqlite3.connect(db_path)

    def identify_domain(self, content):
        if "struct" in content or "void" in content: return "software"
        if re.search(r"(Section|Article|Clause) \d+", content): return "legal"
        return "generic"

    def shatter_unit(self, content, project_id="default"):
        atom_hash = hashlib.sha256(content.encode()).hexdigest()
        domain = self.identify_domain(content)
        atom_id = f"atom_{atom_hash[:8]}"
        
        cursor = self.conn.cursor()
        cursor.execute("""
            INSERT OR REPLACE INTO atoms (id, type, content, hash, domain, status, parent_project)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (atom_id, "unknown_unit", content, atom_hash, domain, 0, project_id))
        self.conn.commit()
        return atom_id

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: spatia-shatter <text_content>")
        sys.exit(1)
    core = ShatterCore()
    print(core.shatter_unit(sys.argv[1]))
