#!/usr/bin/env python3
import sqlite3
import sys
import os

# Ref: Spatia-Materializer-Engine
# Role: Transforms the Universal Semantic Graph (USG) back into linear text

class Materializer:
    def __init__(self, db_path=".spatia/sentinel.db"):
        self.db_path = db_path

    def get_endorsed_atoms(self, project_id="default"):
        """Queries the Sentinel for Level 3 (Endorsed) atoms"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Join atoms with geometry to get spatial ordering
        query = """
            SELECT a.content, g.x, g.y 
            FROM atoms a
            JOIN geometry g ON a.id = g.atom_id
            WHERE a.status = 3 AND a.parent_project = ?
            ORDER BY g.y ASC, g.x ASC
        """
        cursor.execute(query, (project_id,))
        results = cursor.fetchall()
        conn.close()
        return results

    def assemble(self, project_id="default", output_file=None):
        """Sequences atoms by their Anchors to produce the final projection"""
        atoms = self.get_endorsed_atoms(project_id)
        if not atoms:
            print(f"No endorsed atoms found for project: {project_id}")
            return

        linear_text = "\n".join([atom[0] for atom in atoms])
        
        if output_file:
            with open(output_file, 'w') as f:
                f.write(linear_text)
            print(f"Project materialized to: {output_file}")
        else:
            print(linear_text)

if __name__ == "__main__":
    proj_id = sys.argv[1] if len(sys.argv) > 1 else "default"
    out_path = sys.argv[2] if len(sys.argv) > 2 else None
    
    engine = Materializer()
    engine.assemble(proj_id, out_path)
