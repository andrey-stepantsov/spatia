#!/usr/bin/env bash
# Ref: Spatia-Witness-Router-Alpha
# Dispatches Claims based on domain metadata

ATOM_ID=$1
DB="${SENTINEL_DB:-.spatia/sentinel.db}"
LOG_FILE=".spatia/logs/witness.log"

if [ -z "$ATOM_ID" ]; then
    echo "Usage: $0 <atom_id>"
    exit 1
fi

if [ ! -f "$DB" ]; then
    printf "Error: Sentinel DB missing at %s.\n" "$DB"
    exit 1
fi

mkdir -p .spatia/logs

timestamp() {
  date "+%Y-%m-%dT%H:%M:%S%z"
}

# Fetch Domain (Use -r for raw output to avoid quotes if any, though sqlite usually raw by default for simple selects)
DOMAIN=$(sqlite3 "$DB" "SELECT domain FROM atoms WHERE id='$ATOM_ID';")

# Per-Atom Log
LOG_ID=${ATOM_ID//\//_} # Replace / with _
ATOM_LOG=".spatia/logs/${LOG_ID}.log"

# Fetch Content
CONTENT=$(sqlite3 "$DB" "SELECT content FROM atoms WHERE id='$ATOM_ID';")

if [ -z "$CONTENT" ]; then
    printf "Error: No content found for atom %s in DB %s\n" "$ATOM_ID" "$DB"
    exit 1
fi

# Start Log (Global)
printf "[%s] START Atom: %s Domain: %s\n" "$(timestamp)" "$ATOM_ID" "$DOMAIN" >> "$LOG_FILE"
printf "\033[1;33m[WITNESS]\033[0m Routing Atom: %s (Domain: %s)\n" "$ATOM_ID" "$DOMAIN"

# Phase III: Register Symmetry Check
if [ "$DOMAIN" == "Register" ]; then
    printf "\033[1;36m[WITNESS]\033[0m Performing Register Symmetry Check...\n"
    # Capture output to atom log too
    if ! .spatia/bin/spatia-check-registers.py >> "$ATOM_LOG" 2>&1; then
        printf "\033[1;31m[WITNESS]\033[0m Symmetry Check Failed.\n"
        printf "Symmetry Check Failed\n" >> "$ATOM_LOG"
        
        # Log failure
        printf "[%s] END Atom: %s Result: FAILURE (SymmetryCheck) ExitCode: 1\n" "$(timestamp)" "$ATOM_ID" >> "$LOG_FILE"
        exit 1
    fi
    printf "\033[1;32m[WITNESS]\033[0m Symmetry Check Passed.\n"
fi

# Dispatch to Hermetic Witness (Nix)
# Capture output to per-atom log
echo "$CONTENT" | nix-shell --pure .spatia/witness/shell.nix --run "python3 .spatia/witness/verify.py" >> "$ATOM_LOG" 2>&1
EXIT_CODE=$?

# Append atom log content to global log for posterity (optional, but good for trace)
cat "$ATOM_LOG" >> "$LOG_FILE"

if [ $EXIT_CODE -eq 0 ]; then
    RESULT="SUCCESS"
else
    RESULT="FAILURE"
fi

# End Log
printf "[%s] END Atom: %s Result: %s ExitCode: %d\n" "$(timestamp)" "$ATOM_ID" "$RESULT" "$EXIT_CODE" >> "$LOG_FILE"

if [ $EXIT_CODE -eq 0 ]; then
    printf "\033[1;32m[WITNESS]\033[0m Verification Passed.\n"
else
    printf "\033[1;31m[WITNESS]\033[0m Verification Failed.\n"
fi

exit $EXIT_CODE
